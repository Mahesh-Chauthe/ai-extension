apiVersion: v1
kind: Namespace
metadata:
  name: master-system
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: master-api
  namespace: master-system
spec:
  replicas: 1
  selector:
    matchLabels:
      app: master-api
  template:
    metadata:
      labels:
        app: master-api
    spec:
      containers:
      - name: master-api
        image: node:18-alpine
        command: ["/bin/sh"]
        args: ["-c", "echo 'const http = require(\"http\"); const url = require(\"url\"); let organizations = {\"ext_sample123\": {id: \"org1\", name: \"TechCorp Inc\", domain: \"techcorp.com\", adminEmail: \"admin@techcorp.com\", token: \"ext_sample123\", users: 0, userLimit: 50}}; let users = {}; const server = http.createServer((req, res) => { const parsedUrl = url.parse(req.url, true); res.setHeader(\"Access-Control-Allow-Origin\", \"*\"); res.setHeader(\"Access-Control-Allow-Methods\", \"*\"); res.setHeader(\"Access-Control-Allow-Headers\", \"*\"); if (req.method === \"OPTIONS\") { res.writeHead(200); res.end(); return; } let body = \"\"; req.on(\"data\", chunk => body += chunk); req.on(\"end\", () => { console.log(req.method, parsedUrl.pathname); if (parsedUrl.pathname === \"/api/organizations\" && req.method === \"POST\") { const data = JSON.parse(body); const token = \"ext_\" + Math.random().toString(36).substr(2, 16); const org = {...data, id: \"org_\" + Date.now(), token, users: 0}; organizations[token] = org; res.writeHead(200, {\"Content-Type\": \"application/json\"}); res.end(JSON.stringify(org)); } else if (parsedUrl.pathname === \"/api/organizations\") { res.writeHead(200, {\"Content-Type\": \"application/json\"}); res.end(JSON.stringify(Object.values(organizations))); } else if (parsedUrl.pathname.startsWith(\"/api/org/\")) { const token = parsedUrl.pathname.split(\"/\")[3]; const org = organizations[token]; if (org) { res.writeHead(200, {\"Content-Type\": \"application/json\"}); res.end(JSON.stringify(org)); } else { res.writeHead(404, {\"Content-Type\": \"application/json\"}); res.end(JSON.stringify({error: \"Invalid token\"})); } } else if (parsedUrl.pathname === \"/api/users\" && req.method === \"POST\") { const data = JSON.parse(body); const userToken = \"usr_\" + Math.random().toString(36).substr(2, 12); const user = {...data, id: \"user_\" + Date.now(), token: userToken}; users[user.id] = user; if (organizations[data.orgToken]) organizations[data.orgToken].users++; res.writeHead(200, {\"Content-Type\": \"application/json\"}); res.end(JSON.stringify(user)); } else { res.writeHead(200, {\"Content-Type\": \"application/json\"}); res.end(JSON.stringify({status: \"ok\", path: parsedUrl.pathname})); } }); }); server.listen(3000, \"0.0.0.0\", () => console.log(\"API ready on 3000\"));' > server.js && node server.js"]
        ports:
        - containerPort: 3000
---
apiVersion: v1
kind: Service
metadata:
  name: master-api-service
  namespace: master-system
spec:
  selector:
    app: master-api
  ports:
  - name: api
    port: 8080
    targetPort: 3000
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: master-portal
  namespace: master-system
spec:
  replicas: 1
  selector:
    matchLabels:
      app: master-portal
  template:
    metadata:
      labels:
        app: master-portal
    spec:
      containers:
      - name: master-portal
        image: nginx:alpine
        ports:
        - containerPort: 80
        volumeMounts:
        - name: portal-content
          mountPath: /usr/share/nginx/html
      volumes:
      - name: portal-content
        configMap:
          name: master-portal-config
---
apiVersion: v1
kind: Service
metadata:
  name: master-portal-service
  namespace: master-system
spec:
  selector:
    app: master-portal
  ports:
  - name: web
    port: 8090
    targetPort: 80
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: org-portal
  namespace: master-system
spec:
  replicas: 1
  selector:
    matchLabels:
      app: org-portal
  template:
    metadata:
      labels:
        app: org-portal
    spec:
      containers:
      - name: org-portal
        image: nginx:alpine
        ports:
        - containerPort: 80
        volumeMounts:
        - name: org-portal-content
          mountPath: /usr/share/nginx/html
      volumes:
      - name: org-portal-content
        configMap:
          name: org-portal-config
---
apiVersion: v1
kind: Service
metadata:
  name: org-portal-service
  namespace: master-system
spec:
  selector:
    app: org-portal
  ports:
  - name: web
    port: 8091
    targetPort: 80
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: master-portal-config
  namespace: master-system
data:
  index.html: |
    <!DOCTYPE html>
    <html>
    <head>
        <title>Master Portal</title>
        <style>
            body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #0f172a; color: white; }
            .container { max-width: 1000px; margin: 0 auto; }
            .header { background: linear-gradient(135deg, #7c3aed, #a855f7); padding: 2rem; border-radius: 12px; margin-bottom: 2rem; text-align: center; }
            .card { background: #1e293b; padding: 2rem; border-radius: 12px; margin-bottom: 1rem; }
            .btn { background: #7c3aed; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 8px; cursor: pointer; }
            .form-group { margin-bottom: 1rem; }
            .form-group input { width: 100%; padding: 0.75rem; border: 1px solid #475569; border-radius: 8px; background: #334155; color: white; }
            .table { width: 100%; border-collapse: collapse; }
            .table th, .table td { padding: 1rem; text-align: left; border-bottom: 1px solid #334155; }
            .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); }
            .modal-content { background: #1e293b; padding: 2rem; border-radius: 12px; max-width: 500px; margin: 10% auto; }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>👑 Master Portal</h1>
                <p>Enterprise Security System</p>
            </div>
            
            <div class="card">
                <div style="display: flex; justify-content: space-between; margin-bottom: 2rem;">
                    <h2>Organizations</h2>
                    <button class="btn" onclick="showModal()">+ Create Organization</button>
                </div>
                <table class="table">
                    <thead>
                        <tr><th>Organization</th><th>Admin Email</th><th>Access Token</th><th>Org Portal</th></tr>
                    </thead>
                    <tbody id="orgList">
                        <tr>
                            <td>TechCorp Inc</td>
                            <td>admin@techcorp.com</td>
                            <td><code>ext_sample123</code></td>
                            <td><a href="http://localhost:8091" target="_blank">Open Portal</a></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="modal" class="modal">
            <div class="modal-content">
                <h3>Create Organization</h3>
                <form id="createForm">
                    <div class="form-group">
                        <input type="text" id="name" placeholder="Organization Name" required>
                    </div>
                    <div class="form-group">
                        <input type="text" id="domain" placeholder="company.com" required>
                    </div>
                    <div class="form-group">
                        <input type="email" id="adminEmail" placeholder="admin@company.com" required>
                    </div>
                    <div class="form-group">
                        <input type="number" id="userLimit" value="50" required>
                    </div>
                    <button type="submit" class="btn">Create</button>
                    <button type="button" class="btn" onclick="closeModal()">Cancel</button>
                </form>
            </div>
        </div>

        <script>
            function showModal() { document.getElementById('modal').style.display = 'block'; }
            function closeModal() { document.getElementById('modal').style.display = 'none'; }
            
            document.getElementById('createForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const data = {
                    name: document.getElementById('name').value,
                    domain: document.getElementById('domain').value,
                    adminEmail: document.getElementById('adminEmail').value,
                    userLimit: parseInt(document.getElementById('userLimit').value)
                };
                
                try {
                    const response = await fetch('http://localhost:8080/api/organizations', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    
                    const org = await response.json();
                    
                    const row = document.getElementById('orgList').insertRow();
                    row.innerHTML = `
                        <td>${org.name}</td>
                        <td>${org.adminEmail}</td>
                        <td><code>${org.token}</code></td>
                        <td><a href="http://localhost:8091" target="_blank">Open Portal</a></td>
                    `;
                    
                    alert(`Organization Created!

Name: ${org.name}
Access Token: ${org.token}

Organization Admin should:
1. Go to: http://localhost:8091
2. Enter token: ${org.token}`);
                    
                    closeModal();
                    document.getElementById('createForm').reset();
                } catch (error) {
                    alert('Error: Make sure API is running on port 8080');
                }
            });
        </script>
    </body>
    </html>
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: org-portal-config
  namespace: master-system
data:
  index.html: |
    <!DOCTYPE html>
    <html>
    <head>
        <title>Organization Portal</title>
        <style>
            body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #0f172a; color: white; }
            .login { min-height: 100vh; display: flex; align-items: center; justify-content: center; }
            .login-card { background: #1e293b; padding: 3rem; border-radius: 12px; max-width: 400px; }
            .dashboard { display: none; max-width: 1000px; margin: 0 auto; }
            .header { background: linear-gradient(135deg, #059669, #10b981); padding: 2rem; border-radius: 12px; margin-bottom: 2rem; }
            .card { background: #1e293b; padding: 2rem; border-radius: 12px; margin-bottom: 1rem; }
            .btn { background: #059669; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 8px; cursor: pointer; width: 100%; }
            .form-group { margin-bottom: 1rem; }
            .form-group input { width: 100%; padding: 0.75rem; border: 1px solid #475569; border-radius: 8px; background: #334155; color: white; }
            .table { width: 100%; border-collapse: collapse; }
            .table th, .table td { padding: 1rem; text-align: left; border-bottom: 1px solid #334155; }
            .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); }
            .modal-content { background: #1e293b; padding: 2rem; border-radius: 12px; max-width: 500px; margin: 10% auto; }
        </style>
    </head>
    <body>
        <div id="loginScreen" class="login">
            <div class="login-card">
                <h1>🏢 Organization Portal</h1>
                <p>Enter your access token from Master Admin</p>
                <form id="loginForm">
                    <div class="form-group">
                        <input type="text" id="token" placeholder="Access Token (ext_...)" required>
                    </div>
                    <button type="submit" class="btn">Login</button>
                </form>
                <div style="margin-top: 2rem; color: #64748b; font-size: 0.9rem;">
                    <p><strong>Sample Token:</strong> ext_sample123</p>
                </div>
            </div>
        </div>

        <div id="dashboard" class="dashboard">
            <div class="header">
                <h1 id="orgName">Organization Dashboard</h1>
                <p id="orgInfo">Manage users and extension tokens</p>
            </div>
            
            <div class="card">
                <div style="display: flex; justify-content: space-between; margin-bottom: 2rem;">
                    <h2>Users & Extension Tokens</h2>
                    <button class="btn" onclick="showUserModal()">+ Create User</button>
                </div>
                <table class="table">
                    <thead>
                        <tr><th>User</th><th>Email</th><th>Extension Token</th><th>Actions</th></tr>
                    </thead>
                    <tbody id="userList"></tbody>
                </table>
            </div>
        </div>

        <div id="userModal" class="modal">
            <div class="modal-content">
                <h3>Create User</h3>
                <form id="userForm">
                    <div class="form-group">
                        <input type="text" id="userName" placeholder="User Name" required>
                    </div>
                    <div class="form-group">
                        <input type="email" id="userEmail" placeholder="user@company.com" required>
                    </div>
                    <button type="submit" class="btn">Create User</button>
                    <button type="button" class="btn" onclick="closeUserModal()">Cancel</button>
                </form>
            </div>
        </div>

        <script>
            let currentOrg = null;
            let users = [];
            
            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const token = document.getElementById('token').value.trim();
                
                try {
                    const response = await fetch(`http://localhost:8080/api/org/${token}`);
                    if (response.ok) {
                        currentOrg = await response.json();
                        showDashboard();
                    } else {
                        alert('Invalid access token. Please check the token from Master Admin.');
                    }
                } catch (error) {
                    alert('Connection error. Make sure API is running on port 8080.');
                }
            });
            
            function showDashboard() {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                document.getElementById('orgName').textContent = currentOrg.name;
                document.getElementById('orgInfo').textContent = `Admin: ${currentOrg.adminEmail} | Users: ${currentOrg.users}/${currentOrg.userLimit}`;
            }
            
            function showUserModal() { document.getElementById('userModal').style.display = 'block'; }
            function closeUserModal() { document.getElementById('userModal').style.display = 'none'; }
            
            document.getElementById('userForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const userData = {
                    name: document.getElementById('userName').value,
                    email: document.getElementById('userEmail').value,
                    orgToken: currentOrg.token
                };
                
                try {
                    const response = await fetch('http://localhost:8080/api/users', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(userData)
                    });
                    
                    const user = await response.json();
                    users.push(user);
                    
                    const row = document.getElementById('userList').insertRow();
                    row.innerHTML = `
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td><code>${user.token}</code></td>
                        <td><button class="btn" onclick="regenerateToken('${user.id}')">Regenerate</button></td>
                    `;
                    
                    alert(`User Created!

Name: ${user.name}
Extension Token: ${user.token}

Give this token to the user for browser extension setup.`);
                    
                    closeUserModal();
                    document.getElementById('userForm').reset();
                } catch (error) {
                    alert('Error creating user');
                }
            });
            
            function regenerateToken(userId) {
                const user = users.find(u => u.id === userId);
                if (user) {
                    user.token = 'usr_' + Math.random().toString(36).substr(2, 12);
                    alert(`New Extension Token: ${user.token}`);
                    location.reload();
                }
            }
        </script>
    </body>
    </html>